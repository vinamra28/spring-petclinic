# This is a basic workflow to help you get started with Actions

name: CI
on: [push]

env:
  PROJECT: demo-action
  APP_NAME: myapp
  RUNNER_OS: linux

jobs:
  build:
    name: Setup and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      # - name: Maven
      #   run: |
      #     cd ${GITHUB_WORKSPACE}
      #     mvn package
      # - name: Lucas Test Build Action
      #   uses: lstocchi/buildah-action@0.0.6
      #   with:
      #     new-image-name: test2
      #     base-image: docker.io/fabric8/java-alpine-openjdk11-jre
      #     content: target/spring-petclinic-2.3.0.BUILD-SNAPSHOT.jar
      #     entrypoint: |
      #       java
      #       -jar
      #       spring-petclinic-2.3.0.BUILD-SNAPSHOT.jar
      #     port: 8080
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1
        with:
          version: latest

        # Checkout spring petclinic repository
      - name: Checkout
        uses: actions/checkout@v2
        env:
          DEFAULT_BRANCH: main

        # Setup S2i and Build container image
      - name: Setup and Build
        uses: Divyansh42/s2i-build@v0.0.1
        with:
          path_context: "."
          builder_image: "registry.access.redhat.com/openjdk/openjdk-11-rhel7"
          image_name: test2
      - name: Check image created
        run: |
          buildah images
      # - name: Lucas Test Push To Quay Action
      #   uses: lstocchi/push-to-quay-action@0.0.2
      #   with:
      #     image-to-push: test2
      #     quay-registry: ${{ secrets.QUAY_REPO }}/testaction
      #     username: ${{ secrets.QUAY_USERNAME }}
      #     password: ${{ secrets.QUAY_PASSWORD }}
      - name: push images
        run: |
          buildah --storage-driver=overlay push --tls-verify=false --no-cache \
          --creds ${{ secrets.QUAY_USERNAME }}:${{ secrets.QUAY_PASSWORD }} \
          docker://${{ secrets.QUAY_REPO }}/testaction
